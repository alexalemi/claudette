#!/bin/bash

if [ -z "$ANTHROPIC_API_KEY" ]; then
    echo "Error: ANTHROPIC_API_KEY not set" >&2
    exit 1
fi

query="$*"
if [ -z "$query" ]; then
    echo "Usage: c <natural language description>" >&2
    exit 1
fi

# Build JSON payload using jq for proper escaping
payload=$(jq -n --arg query "$query" '{
    model: "claude-haiku-4-5",
    max_tokens: 256,
    messages: [{
        role: "user",
        content: ("Convert this to a single bash command. Output ONLY the command, no explanation, no markdown, no code blocks. Query: " + $query)
    }]
}')

response=$(curl -s https://api.anthropic.com/v1/messages \
    -H "Content-Type: application/json" \
    -H "x-api-key: $ANTHROPIC_API_KEY" \
    -H "anthropic-version: 2023-06-01" \
    -d "$payload")

# Extract command using jq
cmd=$(echo "$response" | jq -r '.content[0].text // empty')

if [ -z "$cmd" ]; then
    echo "Error: Failed to get command" >&2
    exit 1
fi

echo "$cmd"
